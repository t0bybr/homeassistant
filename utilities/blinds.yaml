# =========================================================
# Blinds/LOGO Utility-Skripte (konsistente Benennung)
# =========================================================

script:
  # -------------------------------------------------------
  # Einfache Tilt-Bewegung:
  # - tilt_mode == "on"  → auf tilt_target fahren
  # - tilt_mode == "off" → zurück zur Basisstellung,
  #   abhängig von der letzten Nicht-Tilt-Fahrtrichtung:
  #   • 2 (closing/runter) → Basis "geschlossen" (runter)
  #   • 3 (opening/hoch)  → Basis "offen" (hoch)
  #
  # Erwartete Helpers pro Jalousie:
  # - input_number.blinds_<floor>_<room>_logo_register_target
  # - input_number.blinds_<floor>_<room>_tilt_target
  # - input_number.blinds_<floor>_<room>_tilt_ticks_close
  # - input_number.blinds_<floor>_<room>_tilt_ticks_open
  # - input_boolean.blinds_<floor>_<room>_tilt_lock
  # - input_number.blinds_<floor>_<room>_last_moving_state
  #
  # WICHTIG:
  # - Der Blueprint aktualisiert last_moving_state NICHT,
  #   solange tilt_lock = on → so bleibt die Basisrichtung stabil.
  # -------------------------------------------------------
  util_blinds_tilt_simple:
    alias: "Blinds · Einfache Tilt-Bewegung (mit Referenz je nach letzter Richtung)"
    mode: queued
    fields:
      floor_slug:
        description: "Stockwerk-Slug (z. B. '0')"
      room_slug:
        description: "Raum-Slug (z. B. 'dining_room')"
      tilt_mode:
        description: "'on' = Neigung aktivieren, 'off' = Neigung deaktivieren"
      position_sensor_entity_id:
        description: "Positionssensor in Ticks (0..max_travel_ticks)"
      last_moving_state_entity_id:
        description: "input_number für letzte Nicht-Tilt-Richtung (2=runter,3=hoch)"

    sequence:
      - variables:
          floor_slug_str: "{{ floor_slug | string }}"
          room_slug_str: "{{ room_slug | string }}"

          position_sensor: "{{ position_sensor_entity_id }}"
          last_dir_entity: "{{ last_moving_state_entity_id }}"

          # Abgeleitete Entitäten
          register_target_entity: "input_number.blinds_{{ floor_slug_str }}_{{ room_slug_str }}_logo_register_target"
          tilt_target_entity: "input_number.blinds_{{ floor_slug_str }}_{{ room_slug_str }}_tilt_target"
          tilt_ticks_close_entity: "input_number.blinds_{{ floor_slug_str }}_{{ room_slug_str }}_tilt_ticks_close"
          tilt_ticks_open_entity: "input_number.blinds_{{ floor_slug_str }}_{{ room_slug_str }}_tilt_ticks_open"
          tilt_lock_entity: "input_boolean.blinds_{{ floor_slug_str }}_{{ room_slug_str }}_tilt_lock"

          # Werte
          register_target: "{{ states(register_target_entity) | int }}"
          current_pos: "{{ states(position_sensor) | int }}"
          tilt_target: "{{ states(tilt_target_entity) | int(75) }}"
          tilt_ticks_close: "{{ states(tilt_ticks_close_entity) | int(0) }}"
          tilt_ticks_open: "{{ states(tilt_ticks_open_entity) | int(0) }}"
          last_dir: "{{ states(last_dir_entity) | int }}"
          mode_str: "{{ tilt_mode | string }}"

          # Ticks für Ziel-Neigung relativ zu vertikal
          tilt_up_ticks: >
            {{ (tilt_target / 100.0 * tilt_ticks_open) | round(0) | int }}

      # Lock setzen – während Tilt laufen soll kein Auto-Off / State-Update passieren
      - action: input_boolean.turn_on
        target: { entity_id: "{{ tilt_lock_entity }}" }

      - choose:
          # ---------------------------------------------------
          # TILT EINSCHALTEN → auf tilt_target fahren
          # ---------------------------------------------------
          - conditions: "{{ mode_str == 'on' }}"
            sequence:
              - choose:
                  # Fall 1: Letzte Richtung runter (2) → Lamellen vertikal
                  # → einfach ein Stück hoch
                  - conditions: "{{ last_dir == 2 }}"
                    sequence:
                      - variables:
                          target_pos: "{{ current_pos + tilt_up_ticks }}"
                      - action: mqtt.publish
                        data:
                          topic: "logo/register/set/{{ register_target }}"
                          payload: "{{ target_pos }}"

                  # Fall 2: Letzte Richtung hoch (3) → Lamellen horizontal
                  # → erst runter bis vertikal, dann wieder hoch wie bei Fall 1
                  - conditions: "{{ last_dir == 3 }}"
                    sequence:
                      # Schritt 1: runter bis vertikal
                      - variables:
                          pos_vertical: "{{ current_pos - tilt_ticks_close }}"
                      - action: mqtt.publish
                        data:
                          topic: "logo/register/set/{{ register_target }}"
                          payload: "{{ pos_vertical }}"

                      # kurze Pause, damit der Motor wirklich anläuft / Richtung wechselt
                      - delay: "00:00:02"

                      # Schritt 2: von vertikal ein Stück hoch auf tilt_target
                      - variables:
                          current_pos_after: "{{ states(position_sensor) | int }}"
                          target_pos_tilt: "{{ current_pos_after + tilt_up_ticks }}"
                      - action: mqtt.publish
                        data:
                          topic: "logo/register/set/{{ register_target }}"
                          payload: "{{ target_pos_tilt }}"

          # ---------------------------------------------------
          # TILT AUSSCHALTEN → zurück zur „Basisstellung“
          # ---------------------------------------------------
          - conditions: "{{ mode_str == 'off' }}"
            sequence:
              - choose:
                  # Fall 1: Basisrichtung runter (2) → von gekippt wieder nach unten
                  - conditions: "{{ last_dir == 2 }}"
                    sequence:
                      - variables:
                          target_pos: "{{ current_pos - tilt_up_ticks }}"
                      - action: mqtt.publish
                        data:
                          topic: "logo/register/set/{{ register_target }}"
                          payload: "{{ target_pos }}"

                  # Fall 2: Basisrichtung hoch (3)
                  # ON war: runter bis vertikal, dann hoch um tilt_up_ticks
                  # OFF jetzt: erst um tilt_up_ticks runter (zur vertikalen Stellung),
                  #            dann um tilt_ticks_close hoch (zur horizontalen Stellung)
                  - conditions: "{{ last_dir == 3 }}"
                    sequence:
                      # Schritt 1: von gekippt zur vertikalen Stellung
                      - variables:
                          pos_vertical: "{{ current_pos - tilt_up_ticks }}"
                      - action: mqtt.publish
                        data:
                          topic: "logo/register/set/{{ register_target }}"
                          payload: "{{ pos_vertical }}"

                      - delay: "00:00:02"

                      # Schritt 2: von vertikal zur horizontalen Basisstellung
                      - variables:
                          current_pos_after: "{{ states(position_sensor) | int }}"
                          pos_horizontal: "{{ current_pos_after + tilt_ticks_close }}"
                      - action: mqtt.publish
                        data:
                          topic: "logo/register/set/{{ register_target }}"
                          payload: "{{ pos_horizontal }}"

      # Lock wieder freigeben
      - action: input_boolean.turn_off
        target: { entity_id: "{{ tilt_lock_entity }}" }

  # -------------------------------------------------------
  # Langdruck (Coil halten, bis Button losgelassen / Timeout)
  # -------------------------------------------------------
  util_blinds_longpress:
    alias: "Blinds · Langdruck (Coil halten)"
    mode: restart
    fields:
      is_up:
        description: "true = Hoch-Langdruck, false = Runter-Langdruck"
      coil_up_value:
        description: "LOGO-Coilnummer für Hoch"
      coil_down_value:
        description: "LOGO-Coilnummer für Runter"
      pressed_button_entity_id:
        description: "Der gedrückte Button (binary_sensor.*)"

    sequence:
      - variables:
          coil_num: "{{ (coil_up_value if is_up else coil_down_value) }}"
      - action: mqtt.publish
        data:
          topic: "logo/coil/set/{{ coil_num }}"
          payload: "ON"
      - wait_template: "{{ is_state(pressed_button_entity_id, 'off') }}"
        timeout: "00:00:20" # Safety-Timeout
        continue_on_timeout: true
      - action: mqtt.publish
        data:
          topic: "logo/coil/set/{{ coil_num }}"
          payload: "OFF"

  # -------------------------------------------------------
  # Zähllogik: Klick-Fenster starten + Klick zählen
  # -------------------------------------------------------
  util_blinds_counter_click:
    alias: "Blinds · Zähllogik (Start/Increment)"
    mode: restart
    fields:
      is_up:
        description: "true = Hoch-Taste, false = Runter-Taste"
      counting_flag_entity_id:
        description: "input_boolean zum Markieren des laufenden Zählfensters"
      click_counter_entity_id:
        description: "counter.* für die Klickanzahl"
      last_direction_text_entity_id:
        description: "input_text für letzte Richtung ('up'/'down')"
      cover_entity_id:
        description: "cover.* (für open/close im Fenster)"
      floor_slug:
        description: "Stockwerk-Slug"
      room_slug:
        description: "Raum-Slug"
      state_entity_id:
        description: "input_select State Machine Entity"

    sequence:
      - variables:
          floor_slug_str: "{{ floor_slug | string }}"
          room_slug_str: "{{ room_slug | string }}"

      # Fenster starten, falls nicht aktiv
      - if:
          - condition: template
            value_template: "{{ is_state(counting_flag_entity_id, 'off') }}"
        then:
          - action: input_boolean.turn_on
            target: { entity_id: "{{ counting_flag_entity_id }}" }
          - action: input_text.set_value
            target: { entity_id: "{{ last_direction_text_entity_id }}" }
            data: { value: "{{ 'up' if is_up else 'down' }}" }
          - action: script.turn_on
            target:
              entity_id: script.util_blinds_counter_window
            data:
              variables:
                counting_flag_entity_id: "{{ counting_flag_entity_id }}"
                click_counter_entity_id: "{{ click_counter_entity_id }}"
                last_direction_text_entity_id: "{{ last_direction_text_entity_id }}"
                cover_entity_id: "{{ cover_entity_id }}"
                floor_slug: "{{ floor_slug_str }}"
                room_slug: "{{ room_slug_str }}"
                state_entity_id: "{{ state_entity_id }}"

      # Klick zählen
      - action: counter.increment
        target: { entity_id: "{{ click_counter_entity_id }}" }

  # -------------------------------------------------------
  # Zählfenster (2s): wertet Klickzahl aus & führt Aktionen aus
  # -------------------------------------------------------
  util_blinds_counter_window:
    alias: "Blinds · Zählfenster 2s (Auswertung)"
    mode: restart
    fields:
      counting_flag_entity_id:
        description: "input_boolean (Fenster aktiv?)"
      click_counter_entity_id:
        description: "counter.* (Klickanzahl)"
      last_direction_text_entity_id:
        description: "input_text ('up'/'down')"
      cover_entity_id:
        description: "cover.*"
      floor_slug:
        description: "Stockwerk-Slug"
      room_slug:
        description: "Raum-Slug"
      state_entity_id:
        description: "input_select State Machine Entity"

      on_up_3:
        description: "Script bei 3× up (optional)"
      on_up_4:
        description: "Script bei 4× up (optional)"
      on_down_2:
        description: "Script bei 2× down (optional)"
      on_down_3:
        description: "Script bei 3× down (optional)"
      on_down_4:
        description: "Script bei 4× down (optional)"

    sequence:
      - delay: "00:00:02"
      - variables:
          floor_slug_str: "{{ floor_slug | string }}"
          room_slug_str: "{{ room_slug | string }}"

          clicks: "{{ states(click_counter_entity_id) | int(0) }}"
          dir: "{{ states(last_direction_text_entity_id) }}"
          tilt_enabled_entity: "input_boolean.blinds_{{ floor_slug_str }}_{{ room_slug_str }}_tilt_enabled"

      - choose:
          # Hoch-Taste
          - conditions: "{{ dir == 'up' }}"
            sequence:
              - choose:
                  # 1× up → öffnen + State setzen
                  - conditions: "{{ clicks == 1 }}"
                    sequence:
                      - action: input_select.select_option
                        target: { entity_id: "{{ state_entity_id }}" }
                        data: { option: "moving_user" }
                      - action: cover.open_cover
                        target: { entity_id: "{{ cover_entity_id }}" }

                  # 2× up → Tilt-Bool toggeln
                  - conditions: "{{ clicks == 2 }}"
                    sequence:
                      - action: input_boolean.toggle
                        target: { entity_id: "{{ tilt_enabled_entity }}" }

                  # 3× / 4× up → optional
                  - conditions: "{{ clicks == 3 and (on_up_3 | default('') | string) != '' }}"
                    sequence:
                      - action: script.turn_on
                        target: { entity_id: "{{ on_up_3 }}" }
                  - conditions: "{{ clicks == 4 and (on_up_4 | default('') | string) != '' }}"
                    sequence:
                      - action: script.turn_on
                        target: { entity_id: "{{ on_up_4 }}" }

          # Runter-Taste
          - conditions: "{{ dir == 'down' }}"
            sequence:
              - choose:
                  # 1× down → schließen + State setzen
                  - conditions: "{{ clicks == 1 }}"
                    sequence:
                      - action: input_select.select_option
                        target: { entity_id: "{{ state_entity_id }}" }
                        data: { option: "moving_user" }
                      - action: cover.close_cover
                        target: { entity_id: "{{ cover_entity_id }}" }

                  # 2×/3×/4× down → optional
                  - conditions: "{{ clicks == 2 and (on_down_2 | default('') | string) != '' }}"
                    sequence:
                      - action: script.turn_on
                        target: { entity_id: "{{ on_down_2 }}" }
                  - conditions: "{{ clicks == 3 and (on_down_3 | default('') | string) != '' }}"
                    sequence:
                      - action: script.turn_on
                        target: { entity_id: "{{ on_down_3 }}" }
                  - conditions: "{{ clicks == 4 and (on_down_4 | default('') | string) != '' }}"
                    sequence:
                      - action: script.turn_on
                        target: { entity_id: "{{ on_down_4 }}" }

      - action: input_boolean.turn_off
        target: { entity_id: "{{ counting_flag_entity_id }}" }
      - action: counter.reset
        target: { entity_id: "{{ click_counter_entity_id }}" }
